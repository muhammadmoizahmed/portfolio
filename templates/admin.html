{% extends "base.html" %}
{% block content %}
<section class="max-w-6xl mx-auto px-4 py-16">
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h2 class="text-3xl font-semibold">Admin Panel</h2>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-4 space-y-2">
            {% for category, msg in messages %}
              <div class="px-4 py-3 rounded {{ 'bg-teal-700 text-white' if category=='success' else 'bg-red-700 text-white' }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>
    <a href="{{ url_for('logout') }}" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-medium transition-colors">Logout</a>
  </div>

  <div class="flex flex-col md:flex-row gap-8">
    <!-- Sidebar Navigation -->
    <div class="md:w-1/4 flex flex-col gap-2 md:sticky md:top-24">
      <button onclick="showTab('site')" id="tab-site" class="text-left px-4 py-3 rounded-xl bg-gray-800 hover:bg-teal-700 focus:bg-teal-600 transition-colors">Site Info</button>
      <button onclick="showTab('social')" id="tab-social" class="text-left px-4 py-3 rounded-xl bg-gray-800 hover:bg-teal-700 focus:bg-teal-600 transition-colors">Social Links</button>
      <button onclick="showTab('about')" id="tab-about" class="text-left px-4 py-3 rounded-xl bg-gray-800 hover:bg-teal-700 focus:bg-teal-600 transition-colors">About Me</button>
      <button onclick="showTab('skills')" id="tab-skills" class="text-left px-4 py-3 rounded-xl bg-gray-800 hover:bg-teal-700 focus:bg-teal-600 transition-colors">Skills</button>
      <button onclick="showTab('projects')" id="tab-projects" class="text-left px-4 py-3 rounded-xl bg-gray-800 hover:bg-teal-700 focus:bg-teal-600 transition-colors">Projects</button>
    </div>

    <!-- Content Area -->
    <div class="md:w-3/4">
      
      <!-- Site Info Tab -->
      <div id="content-site" class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-4">Site Information</h3>
        <form action="{{ url_for('admin') }}" method="POST" enctype="multipart/form-data" class="space-y-4 border border-gray-800 rounded-2xl p-6 bg-gray-800/50">
          <input type="hidden" name="section" value="site">
          <div>
            <label class="block text-sm mb-2">Site Title</label>
            <input name="title" type="text" value="{{ content.site.title }}" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
          </div>
          <div>
            <label class="block text-sm mb-2">Brand Name</label>
            <input name="brand" type="text" value="{{ content.site.brand }}" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
          </div>
          <div>
            <label class="block text-sm mb-2">Role / Subtitle</label>
            <input name="role" type="text" value="{{ content.site.role }}" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
          </div>
          <div>
            <label class="block text-sm mb-2">Hero Description</label>
            <textarea name="description" rows="3" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">{{ content.site.description }}</textarea>
          </div>
          <div>
            <label class="block text-sm mb-2">Profile Image</label>
            {% if content.site.image %}
            <img src="{{ url_for('static', filename='uploads/' + content.site.image) }}" class="h-24 w-24 rounded-full object-cover mb-2 border border-gray-700">
            {% endif %}
            <input name="image" type="file" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-teal-600 file:text-white hover:file:bg-teal-500">
            <p class="text-xs text-gray-500 mt-1">Recommended size: 400x400px</p>
          </div>
          <button type="submit" class="px-6 py-3 rounded bg-teal-600 hover:bg-teal-500">Save Site Info</button>
        </form>
      </div>

      <!-- Social Links Tab -->
      <div id="content-social" class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-4">Social Links</h3>
        <div class="grid md:grid-cols-2 gap-8">
           <!-- Add Link Form -->
           <div class="border border-gray-800 rounded-2xl p-6 bg-gray-800/50 h-fit">
              <h4 class="text-lg font-medium mb-3">Add / Update Link</h4>
              <form action="{{ url_for('admin') }}" method="POST" enctype="multipart/form-data" class="space-y-4" id="social-form">
                 <input type="hidden" name="section" value="social">
                 <input type="hidden" name="action" value="add" id="social-action">
                 <input type="hidden" name="index" id="social-index">
                 <div>
                    <label class="block text-sm mb-2">Platform Name</label>
                 <input name="name" id="social-name" type="text" placeholder="GitHub" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" required>
                 </div>
                 <div>
                    <label class="block text-sm mb-2">URL</label>
                    <input name="url" id="social-url" type="url" placeholder="https://..." class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" required>
                 </div>
                 <div>
                    <label class="block text-sm mb-2">Icon Class (optional if image uploaded)</label>
                    <input name="icon" id="social-icon" type="text" placeholder="fa-brands fa-github" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
                 </div>
                 <div>
                    <label class="block text-sm mb-2">Or Upload Icon/Image</label>
                    <input name="image" type="file" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-teal-600 file:text-white hover:file:bg-teal-500">
                    <p class="text-xs text-gray-500 mt-1">Recommended size: 64x64px or SVG</p>
                 </div>
                 <div class="flex gap-2">
                   <button type="submit" class="flex-1 px-6 py-3 rounded bg-teal-600 hover:bg-teal-500">Save</button>
                   <button type="button" onclick="resetSocialForm()" class="px-4 py-3 rounded bg-gray-700 hover:bg-gray-600">Clear</button>
                 </div>
              </form>
           </div>
           <!-- List -->
           <div class="space-y-2">
              <h4 class="text-lg font-medium mb-3">Current Links</h4>
              {% for social in content.social %}
              <div class="flex items-center justify-between p-3 rounded bg-gray-800 border border-gray-700">
                 <div class="flex items-center gap-3 overflow-hidden">
                    {% if social.image %}
                    <img src="{{ url_for('static', filename='uploads/' + social.image) }}" class="w-6 h-6 object-contain">
                    {% else %}
                    <i class="{{ social.icon }} text-teal-400 w-6 text-center"></i>
                    {% endif %}
                    <div class="truncate">
                      <div class="font-medium">{{ social.name }}</div>
                      <div class="text-xs text-gray-500 truncate">{{ social.url }}</div>
                    </div>
                 </div>
                 <div class="flex gap-2 flex-shrink-0">
                   <button onclick="editSocial({{ loop.index0 }}, this)" data-social='{{ social|tojson|forceescape }}' class="text-teal-400 hover:text-teal-300"><i class="fa-solid fa-pen"></i></button>
                   <form action="{{ url_for('admin') }}" method="POST" class="inline" onsubmit="return confirm('Delete?');">
                      <input type="hidden" name="section" value="social">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="index" value="{{ loop.index0 }}">
                      <button type="submit" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                   </form>
                 </div>
              </div>
              {% endfor %}
           </div>
        </div>
      </div>

      <!-- About Tab -->
      <div id="content-about" class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-4">About Section</h3>
        <form action="{{ url_for('admin') }}" method="POST" class="space-y-4 border border-gray-800 rounded-2xl p-6 bg-gray-800/50">
          <input type="hidden" name="section" value="about">
          <div>
            <label class="block text-sm mb-2">Paragraph</label>
            <textarea name="paragraph" rows="8" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">{{ content.about.paragraph }}</textarea>
          </div>
          <button type="submit" class="px-6 py-3 rounded bg-teal-600 hover:bg-teal-500">Save About Section</button>
        </form>
      </div>

      <!-- Skills Tab -->
      <div id="content-skills" class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-4">Skills Management</h3>
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Add/Edit Skill -->
          <div class="border border-gray-800 rounded-2xl p-6 bg-gray-800/50 h-fit">
            <h4 class="text-lg font-medium mb-3">Add / Update Skill</h4>
            <form action="{{ url_for('admin') }}" method="POST" enctype="multipart/form-data" class="space-y-4" id="skill-form">
              <input type="hidden" name="section" value="skills">
              <input type="hidden" name="action" value="add" id="skill-action">
              <input type="hidden" name="index" id="skill-index">
              <div>
                <label class="block text-sm mb-2">Skill Name</label>
              <input name="name" id="skill-name" type="text" placeholder="e.g. Python" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" required>
              </div>
              <div>
                <label class="block text-sm mb-2">Icon Class (FontAwesome)</label>
                <input name="icon" id="skill-icon" type="text" placeholder="e.g. fa-brands fa-python" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
              </div>
              <div>
                <label class="block text-sm mb-2">Or Upload Image</label>
                <input name="image" type="file" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-teal-600 file:text-white hover:file:bg-teal-500">
                <p class="text-xs text-gray-500 mt-1">If image is uploaded, it overrides the icon. (Recommended size: 64x64px or SVG)</p>
              </div>
              <div class="flex gap-2">
                <button type="submit" class="flex-1 px-6 py-3 rounded bg-teal-600 hover:bg-teal-500">Save</button>
                <button type="button" onclick="resetSkillForm()" class="px-4 py-3 rounded bg-gray-700 hover:bg-gray-600">Clear</button>
              </div>
            </form>
          </div>
          <!-- List Skills -->
          <div class="space-y-2">
            <h4 class="text-lg font-medium mb-3">Current Skills</h4>
            {% for skill in content.skills %}
            <div class="flex items-center justify-between p-3 rounded bg-gray-800 border border-gray-700">
              <div class="flex items-center gap-3">
                {% if skill.image %}
                <img src="{{ url_for('static', filename='uploads/' + skill.image) }}" class="w-8 h-8 object-contain">
                {% else %}
                <i class="{{ skill.icon }} text-teal-400 w-8 text-center text-xl"></i>
                {% endif %}
                <span>{{ skill.name }}</span>
              </div>
              <div class="flex gap-2">
                <button onclick="editSkill({{ loop.index0 }}, this)" data-skill='{{ skill|tojson|forceescape }}' class="text-teal-400 hover:text-teal-300"><i class="fa-solid fa-pen"></i></button>
                <form action="{{ url_for('admin') }}" method="POST" class="inline" onsubmit="return confirm('Delete this skill?');">
                  <input type="hidden" name="section" value="skills">
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="index" value="{{ loop.index0 }}">
                  <button type="submit" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Projects Tab -->
      <div id="content-projects" class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-4">Project Management</h3>
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Add/Edit Form -->
          <div class="border border-gray-800 rounded-2xl p-6 bg-gray-800/50 h-fit sticky top-24">
            <h4 class="text-lg font-medium mb-3">Add / Update Project</h4>
            <form action="{{ url_for('admin') }}" method="POST" enctype="multipart/form-data" class="space-y-4" id="project-form">
              <input type="hidden" name="section" value="project">
              <input type="hidden" name="action" value="save">
              <div>
                <label class="block text-sm mb-2">Index (leave empty for new)</label>
                <input name="index" id="proj-index" type="text" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" placeholder="New Project">
              </div>
              <div>
                <label class="block text-sm mb-2">Title</label>
                <input name="title" id="proj-title" type="text" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" required>
              </div>
              <div>
                <label class="block text-sm mb-2">Description</label>
                <textarea name="description" id="proj-desc" rows="4" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600" required></textarea>
              </div>
              <div>
                <label class="block text-sm mb-2">GitHub Link</label>
                <input name="link" id="proj-link" type="url" class="w-full px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-600">
              </div>
              <div>
                <label class="block text-sm mb-2">Upload Images</label>
                <input name="new_images" type="file" multiple class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-teal-600 file:text-white hover:file:bg-teal-500">
                <p class="text-xs text-gray-500 mt-1">Recommended size: 1200x800px</p>
              </div>
              <div id="proj-existing-images" class="hidden">
                 <label class="block text-sm mb-2">Existing Images (Check to delete)</label>
                 <div id="proj-images-list" class="flex flex-wrap gap-2"></div>
              </div>
              <div class="flex gap-2">
                <button type="submit" class="flex-1 px-6 py-3 rounded bg-teal-600 hover:bg-teal-500">Save</button>
                <button type="button" onclick="resetProjectForm()" class="px-4 py-3 rounded bg-gray-700 hover:bg-gray-600">Clear</button>
              </div>
            </form>
          </div>
          <!-- Project List -->
          <div class="space-y-4">
            <h4 class="text-lg font-medium mb-3">Existing Projects</h4>
            {% for proj in content.projects.all %}
            <div class="border border-gray-800 rounded-lg p-4 bg-gray-800/50 relative group">
              <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="editProject({{ loop.index0 }}, this)" data-project='{{ proj|tojson|forceescape }}' class="p-2 bg-teal-600 rounded text-white hover:bg-teal-500"><i class="fa-solid fa-pen"></i></button>
                <form action="{{ url_for('admin') }}" method="POST" onsubmit="return confirm('Delete this project?');">
                    <input type="hidden" name="section" value="project">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="index" value="{{ loop.index0 }}">
                    <button type="submit" class="p-2 bg-red-600 rounded text-white hover:bg-red-500"><i class="fa-solid fa-trash"></i></button>
                </form>
              </div>
              <div class="text-sm text-gray-400 mb-1">#{{ loop.index0 }}</div>
              <h5 class="font-semibold text-lg">{{ proj.title }}</h5>
              <p class="text-gray-400 text-sm mt-1 line-clamp-2">{{ proj.description }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  function showTab(tabId) {
    // Hide all contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // Show selected
    document.getElementById('content-' + tabId).classList.remove('hidden');
    
    // Update tab styles
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
      el.classList.remove('bg-teal-600', 'text-white');
      el.classList.add('bg-gray-800');
    });
    document.getElementById('tab-' + tabId).classList.remove('bg-gray-800');
    document.getElementById('tab-' + tabId).classList.add('bg-teal-600', 'text-white');
    
    // Persist to local storage
    localStorage.setItem('adminTab', tabId);
  }

  function editProject(index, btn) {
    const data = JSON.parse(btn.getAttribute('data-project'));
    document.getElementById('proj-index').value = index;
    document.getElementById('proj-title').value = data.title;
    document.getElementById('proj-desc').value = data.description;
    document.getElementById('proj-link').value = data.link || "";
    
    // Handle existing images
    const imgContainer = document.getElementById('proj-images-list');
    imgContainer.innerHTML = "";
    if (data.images && data.images.length > 0) {
       document.getElementById('proj-existing-images').classList.remove('hidden');
       data.images.forEach(img => {
          const div = document.createElement('div');
          div.className = "relative inline-block";
          div.innerHTML = `
            <img src="/static/uploads/${img}" class="h-16 w-16 object-cover rounded border border-gray-600">
            <label class="absolute -top-2 -right-2 bg-red-600 rounded-full p-1 cursor-pointer hover:bg-red-500 shadow-md">
               <input type="checkbox" name="delete_images" value="${img}" class="hidden peer">
               <i class="fa-solid fa-xmark text-white text-xs block w-3 h-3 text-center leading-3 peer-checked:opacity-50"></i>
               <div class="absolute inset-0 bg-red-800/80 rounded-full hidden peer-checked:block pointer-events-none"></div>
            </label>
          `;
          // Add visual feedback for deletion
          const checkbox = div.querySelector('input');
          const imgEl = div.querySelector('img');
          checkbox.addEventListener('change', function() {
             if(this.checked) imgEl.classList.add('opacity-25', 'grayscale');
             else imgEl.classList.remove('opacity-25', 'grayscale');
          });
          imgContainer.appendChild(div);
       });
    } else {
       document.getElementById('proj-existing-images').classList.add('hidden');
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function resetProjectForm() {
    document.getElementById('project-form').reset();
    document.getElementById('proj-index').value = "";
    document.getElementById('proj-existing-images').classList.add('hidden');
    document.getElementById('proj-images-list').innerHTML = "";
  }

  function editSkill(index, btn) {
    const data = JSON.parse(btn.getAttribute('data-skill'));
    document.getElementById('skill-index').value = index;
    document.getElementById('skill-name').value = data.name;
    document.getElementById('skill-icon').value = data.icon || "";
    document.getElementById('skill-action').value = "update";
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function resetSkillForm() {
    document.getElementById('skill-form').reset();
    document.getElementById('skill-index').value = "";
    document.getElementById('skill-action').value = "add";
  }

  function editSocial(index, btn) {
    const data = JSON.parse(btn.getAttribute('data-social'));
    document.getElementById('social-index').value = index;
    document.getElementById('social-name').value = data.name;
    document.getElementById('social-url').value = data.url;
    document.getElementById('social-icon').value = data.icon || "";
    document.getElementById('social-action').value = "update";
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function resetSocialForm() {
    document.getElementById('social-form').reset();
    document.getElementById('social-index').value = "";
    document.getElementById('social-action').value = "add";
  }

  // Init tab
  document.addEventListener("DOMContentLoaded", () => {
    const savedTab = localStorage.getItem('adminTab') || 'site';
    showTab(savedTab);
  });
</script>
{% endblock %}
